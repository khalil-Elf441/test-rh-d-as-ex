---
- name: Create VM with custom MAC and cloud-init for static IP
  command: >
    oc create -f - -n web-app-ns <<EOF
    apiVersion: kubevirt.io/v1
    kind: VirtualMachine
    metadata:
      name: legacy-app-vm
    spec:
      template:
        spec:
          domain:
            devices:
              interfaces:
              - name: default
                macAddress: '02:00:00:00:00:01'
                masquerade: {}
          networks:
          - name: default
            pod: {}
          volumes:
          - name: cloudinitdisk
            cloudInitNoCloud:
              networkData: |
                version: 2
                ethernets:
                  eth0:
                    dhcp4: no
                    addresses: [10.1.2.100/24]
                    gateway4: 10.1.2.1
                    nameservers:
                      addresses: [8.8.8.8]
    EOF

- name: Create NetworkPolicy
  command: >
    oc create -f - -n web-app-ns <<EOF
    apiVersion: networking.k8s.io/v1
    kind: NetworkPolicy
    metadata:
      name: allow-legacy-monitoring
    spec:
      podSelector:
        matchLabels:
          kubevirt.io/domain: legacy-app-vm
      policyTypes:
      - Ingress
      ingress:
      - from:
        - ipBlock:
            cidr: 10.1.2.200/32
    EOF

- name: Start the VM
  command: oc virt start legacy-app-vm -n web-app-ns
